# nginx/sites-enabled/nebulosamagica.com

server {
    listen 80;
    listen 443 ssl http2;
    server_name nebulosamagica.com www.nebulosamagica.com;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/nebulosamagica.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nebulosamagica.com/privkey.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Logs
    access_log /var/log/nginx/nebulosa_access.log;
    error_log /var/log/nginx/nebulosa_error.log;

    # =======================
    # APLICACIÓN REACT (Funcionalidades Esotéricas)
    # =======================
    
    # Rutas de la aplicación React
    location /app/ {
        proxy_pass http://frontend:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Para React Router
        try_files $uri $uri/ /index.html;
    }

    # API Backend (Node.js)
    location /api/ {
        proxy_pass http://backend:5050/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Aumentar timeouts para IA
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Assets estáticos de React
    location /assets/ {
        proxy_pass http://frontend:3000/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # =======================
    # WORDPRESS (Contenido y Tienda)
    # =======================

    # Homepage principal (WordPress)
    location = / {
        proxy_pass http://wordpress:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Blog y páginas de contenido
    location ~ ^/(blog|tienda|sobre-nosotros|contacto|legal|politica-privacidad)/ {
        proxy_pass http://wordpress:80$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WooCommerce
    location ~ ^/(carrito|checkout|mi-cuenta|tienda)/ {
        proxy_pass http://wordpress:80$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WordPress admin y wp-content
    location ~ ^/(wp-admin|wp-content|wp-includes|wp-json)/ {
        proxy_pass http://wordpress:80$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WordPress uploads con cache
    location ~ ^/wp-content/uploads/ {
        proxy_pass http://wordpress:80$request_uri;
        expires 30d;
        add_header Cache-Control "public";
    }

    # =======================
    # REDIRECCIONES Y COMPATIBILIDAD
    # =======================

    # Redirects de rutas antiguas a nuevas
    location /tarot {
        return 301 /app/tarot;
    }

    location /runas {
        return 301 /app/runas;
    }

    location /dashboard {
        return 301 /app/dashboard;
    }

    # Páginas específicas que van a WordPress
    location ~ ^/(inicio|home)/?$ {
        return 301 /;
    }

    # =======================
    # FALLBACKS
    # =======================

    # Si no coincide con nada, intentar WordPress primero
    location / {
        proxy_pass http://wordpress:80$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Si WordPress devuelve 404, intentar React
        error_page 404 = @react_fallback;
    }

    location @react_fallback {
        proxy_pass http://frontend:3000$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =======================
    # OPTIMIZACIONES
    # =======================

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # Rate limiting
    location /api/auth/ {
        limit_req zone=auth burst=5 nodelay;
        proxy_pass http://backend:5050/api/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name nebulosamagica.com www.nebulosamagica.com;
    return 301 https://$server_name$request_uri;
}