generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model FeedbackBizum {
  id        String   @id @default(cuid())
  userId    String?
  opinion   String
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model Objetivo {
  id            String   @id @default(cuid())
  clave         String   @unique
  descripcion   String?
  valor         Int
  periodo       String?
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

model User {
  id                        String                     @id @default(cuid())
  email                     String                     @unique
  username                  String?
  password                  String
  avatar                    String?
  birthDate                 DateTime?
  zodiacSign                String?
  role                      UserRole                   @default(USER)
  subscriptionPlan          SubscriptionPlan           @default(FREE)
  subscriptionStatus        SubscriptionStatus         @default(INACTIVE)
  subscriptionExpiry        DateTime?
  readingsThisMonth         Int                        @default(0)
  biography                 String?
  newsletter                Boolean                    @default(false)
  emailNotifications        Boolean                    @default(true)
  smsNotifications          Boolean                    @default(false)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  lastLogin                 DateTime?
  preferences               Json?
  autoRenewal               Boolean                    @default(false)
  readingBonus              Int                        @default(0)
  trialActive               Boolean                    @default(false)
  trialExpiry               DateTime?
  aiDescription             String?
  geoDescription            String?
  resetPasswordExpires      DateTime?
  resetPasswordToken        String?
  feedbackBizum             FeedbackBizum[]
  trialCoupons              TrialCoupon[]
  anonUserStats             AnonUserStats[]
  consentimientosNewsletter ConsentimientoNewsletter[]
  dreams                    Dream[]
  emailLogs                 EmailLog[]
  expenses                  Expense[]
  natalChart                NatalChart?
  openaiCalls               OpenAICall[]
  personalizedHoroscopes    PersonalizedHoroscope[]
  readings                  Reading[]
  subscriptionHistory       SubscriptionHistory[]
  weeklyBonuses             WeeklyBonus[]

  @@map("users")
}

model Deck {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  imageUrl    String?
  type        String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  runes       Rune[]
  tarotCards  TarotCard[]

  @@map("decks")
}

model TarotCard {
  id              String   @id @default(cuid())
  name            String
  cardNumber      Int?
  arcana          String
  suit            String?
  meaning         String
  reversedMeaning String
  keywords        String[]
  imageUrl        String
  deckType        String
  prompt          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deckId          String?
  deck            Deck?    @relation(fields: [deckId], references: [id])

  @@map("tarot_cards")
}

model Rune {
  id              String   @id @default(cuid())
  name            String
  symbol          String
  meaning         String
  imageUrl        String?
  prompt          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deckId          String?
  svg             String?
  keywords        String[]
  reversedMeaning String?
  runeSet         String?
  deck            Deck?    @relation(fields: [deckId], references: [id])

  @@map("runes")
}

model Reading {
  id             String      @id @default(cuid())
  userId         String?
  type           ReadingType
  spreadType     String
  deckType       String?
  question       String
  cards          Json
  interpretation String
  anonBirthDate  DateTime?
  anonGender     String?
  createdAt      DateTime    @default(now())
  user           User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("readings")
}

model AnonUserStats {
  id        String   @id @default(cuid())
  userId    String?
  fechaNac  DateTime
  genero    String
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@map("anon_user_stats")
}

model SubscriptionHistory {
  id        String             @id @default(cuid())
  userId    String
  plan      SubscriptionPlan
  status    SubscriptionStatus
  startDate DateTime
  endDate   DateTime?
  amount    Float
  stripeId  String?
  createdAt DateTime           @default(now())
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscription_history")
}

model HoroscopeCache {
  id         String   @id @default(cuid())
  zodiacSign String
  date       DateTime
  content    String
  createdAt  DateTime @default(now())

  @@unique([zodiacSign, date])
  @@map("horoscope_cache")
}

model Income {
  id              String         @id @default(cuid())
  description     String
  amount          Int
  source          String
  date            DateTime
  category        IncomeCategory @default(SUBSCRIPTION)
  stripePaymentId String?
  userId          String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("income")
}

model Expense {
  id          String          @id @default(cuid())
  description String
  amount      Int
  category    ExpenseCategory
  date        DateTime
  recurring   Boolean         @default(false)
  notes       String?
  createdById String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdBy   User            @relation(fields: [createdById], references: [id])

  @@map("expenses")
}

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique
  newUsers        Int      @default(0)
  activeUsers     Int      @default(0)
  totalUsers      Int      @default(0)
  totalReadings   Int      @default(0)
  tarotReadings   Int      @default(0)
  runeReadings    Int      @default(0)
  dailyRevenue    Int      @default(0)
  subscriptions   Int      @default(0)
  oneTimePayments Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("daily_stats")
}

model TrialCoupon {
  id        String    @id @default(cuid())
  code      String    @unique
  isActive  Boolean   @default(true)
  usedBy    String?
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User?     @relation(fields: [usedBy], references: [id])
}

model EmailLog {
  id       String    @id @default(cuid())
  userId   String?
  email    String
  type     String
  subject  String?
  sentAt   DateTime  @default(now())
  openedAt DateTime?
  user     User?     @relation(fields: [userId], references: [id])

  @@map("email_log")
}

model OpenAICall {
  id        String   @id @default(cuid())
  userId    String?
  prompt    String?
  model     String?
  tokens    Int?
  cost      Float
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@map("openai_call")
}

model ConsentimientoNewsletter {
  id                 String   @id @default(cuid())
  email              String
  ip                 String?
  acceptedAt         DateTime @default(now())
  acceptedLegal      Boolean  @default(true)
  userId             String?
  acceptedNewsletter Boolean  @default(false)
  user               User?    @relation(fields: [userId], references: [id])

  @@map("consentimiento_newsletter")
}

model Dream {
  id             String   @id @default(cuid())
  userId         String
  dreamText      String
  feelings       String[]
  interpretation String?
  date           DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("dreams")
}

model NatalChart {
  id                     String                  @id @default(cuid())
  userId                 String                  @unique
  birthDate              DateTime
  birthTime              String?
  birthLocation          Json
  zodiacSign             String
  planetPositions        Json
  houses                 Json
  aspects                Json
  interpretation         String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  personalizedHoroscopes PersonalizedHoroscope[]

  @@map("natal_charts")
}

model PersonalizedHoroscope {
  id           String     @id @default(cuid())
  userId       String
  natalChartId String
  content      String
  transits     String
  zodiacSign   String
  date         DateTime
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  natalChart   NatalChart @relation(fields: [natalChartId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("personalized_horoscopes")
}

model WeeklyBonus {
  id               String      @id @default(cuid())
  userId           String
  amount           Float
  currency         String      @default("EUR")
  purchaseDate     DateTime    @default(now())
  activatedAt      DateTime?
  expiresAt        DateTime?
  status           BonusStatus @default(PURCHASED)
  paymentMethod    String?
  paymentReference String?
  features         Json?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("weekly_bonuses")
}

enum ReadingType {
  TAROT
  RUNES
}

enum UserRole {
  USER
  ADMIN
  ECOMMERCE
  BLOG
}

enum SubscriptionPlan {
  INVITADO
  INICIADO
  ADEPTO
  MAESTRO
  ESENCIAL
  PREMIUM
  FREE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELED
  EXPIRED
}

enum IncomeCategory {
  SUBSCRIPTION
  ONE_TIME_PAYMENT
  AFFILIATE
  OTHER
}

enum ExpenseCategory {
  HOSTING
  ADVERTISING
  SOFTWARE
  CONTENT
  OFFICE
  LEGAL
  OTHER
}

enum BonusStatus {
  PURCHASED
  ACTIVE
  EXPIRED
  REFUNDED
}
